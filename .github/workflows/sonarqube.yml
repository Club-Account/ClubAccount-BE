name: SonarQube Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sonarqube:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check if tests exist and run accordingly
        run: |
          if ./gradlew tasks --all | grep -q '^test '; then
            echo "✅ 테스트 코드가 존재합니다. 실행합니다."
            ./gradlew build --info
          else
            echo "⚠️ 테스트 코드가 없습니다. 테스트를 제외하고 빌드합니다."
            ./gradlew build -x test --info
          fi

      - name: SonarQube Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonarqube --info
